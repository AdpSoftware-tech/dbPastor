generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Rol {
  SuperADMIN
  SECRETARIAAsociacion
  PASTOR
  SECRETARIAIglesia
  MIEMBRO
}

model Usuario {
  id            String   @id @default(uuid())
  nombre        String
  apellidos     String
  email         String   @unique
  telefono      String   @unique
  password      String
  rol           Rol      @default(MIEMBRO)
  codigoUnico   String   @unique
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  // Relaciones 1-1
  pastorInfo    Pastor?   @relation("UsuarioPastor")
  miembroInfo   Miembro?  @relation("UsuarioMiembro")

  asociacionId   String?
  asociacion     Asociacion? @relation("SecretariasDeAsociacion", fields: [asociacionId], references: [id])

  // Secretaria de Iglesia
  iglesiaId         String?
  iglesiaSecretaria Iglesia? @relation("SecretariasDeIglesia", fields: [iglesiaId], references: [id])

  tokens Token[]

  // Eventos creados
  eventosCreados Evento[] @relation("UsuarioCreador")
}

model Pastor {
  id                String    @id @default(uuid())
  usuarioId         String    @unique
  licenciaPastoral  String?
  fechaOrdenacion   DateTime?
  tokenAutoregistro String?   @unique
  tokenUsado        Boolean   @default(false)

  usuario Usuario @relation("UsuarioPastor", fields: [usuarioId], references: [id])

  asociacionId String?
  asociacion   Asociacion? @relation(fields: [asociacionId], references: [id])

  distritoId String?
  distrito   Distrito? @relation(fields: [distritoId], references: [id])

  iglesias  Iglesia[]
  mensajes  MensajeMotivacion[]
  bautismos Bautismo[]
}

model Miembro {
  id              String    @id @default(uuid())
  usuarioId       String    @unique
  bautizado       Boolean   @default(false)
  fechaBautismo   DateTime?
  fechaNacimiento DateTime
  codigoMiembro   String    @unique

  usuario Usuario @relation("UsuarioMiembro", fields: [usuarioId], references: [id])

  iglesiaId String
  iglesia   Iglesia @relation(fields: [iglesiaId], references: [id])

  oraciones OracionMiembro[]
  bautismos Bautismo[]
}

model Asociacion {
  id        String     @id @default(uuid())
  nombre    String
  distritos Distrito[]
  pastores  Pastor[]
  secretarias Usuario[] @relation("SecretariasDeAsociacion")
}

model Distrito {
  id           String     @id @default(uuid())
  nombre       String
  asociacionId String
  asociacion   Asociacion @relation(fields: [asociacionId], references: [id])
  iglesias     Iglesia[]
  pastores     Pastor[]
}

model Iglesia {
  id          String    @id @default(uuid())
  nombre      String
  codigo      String    @unique
  direccion   String
  telefono    String?
  distritoId  String
  distrito    Distrito  @relation(fields: [distritoId], references: [id])

  pastorId String?
  pastor   Pastor? @relation(fields: [pastorId], references: [id])

  miembros    Miembro[]
  secretarias Usuario[] @relation("SecretariasDeIglesia")

  eventos Evento[]
}

model MensajeMotivacion {
  id       String   @id @default(uuid())
  mensaje  String
  creadoEn DateTime @default(now())
  pastorId String
  pastor   Pastor   @relation(fields: [pastorId], references: [id])
}

model OracionMiembro {
  id        String   @id @default(uuid())
  peticion  String
  creadoEn  DateTime @default(now())
  miembroId String
  miembro   Miembro  @relation(fields: [miembroId], references: [id])
}

model Bautismo {
  id        String   @id @default(uuid())
  fecha     DateTime @default(now())
  miembroId String
  miembro   Miembro  @relation(fields: [miembroId], references: [id])
  pastorId  String
  pastor    Pastor   @relation(fields: [pastorId], references: [id])
}

model Evento {
  id            String   @id @default(uuid())
  nombre        String
  descripcion   String?
  fechaInicio   DateTime
  fechaFin      DateTime
  lugar         String
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  iglesiaId String
  iglesia   Iglesia @relation(fields: [iglesiaId], references: [id])

  creadoPorId String
  creadoPor   Usuario @relation("UsuarioCreador", fields: [creadoPorId], references: [id])
}

model Token {
  id         String   @id @default(uuid())
  tokenHash  String   @unique
  usuarioId  String
  usuario    Usuario  @relation(fields: [usuarioId], references: [id])
  expiraEn   DateTime
  invalidado Boolean  @default(false)
  creadoEn   DateTime @default(now())
}
